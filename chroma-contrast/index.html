<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>chroma.contrast</title>
  <script src="../extLibs/chroma-2.4.2.min.js"></script>
  <script src="../extLibs/jquery-3.4.1.min.js"></script>
  <script src="../extLibs/popper-2.9.2.min.js"></script>
  <script src="../extLibs/bootstrap-5.0.2-dist/js/bootstrap.min.js"></script>

  <link href="../extLibs/bootstrap-5.0.2-dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../extLibs/bootstrap-icons-1.8.1/bootstrap-icons.css">

  <style>
    input {
      height: 50px;
      font-size: 1em;
    }

    input[type="checkbox"] {
      width: 25px;
      height: 30px;
    }

    #rowLockedRGB label {
      width: 25px;
    }

    #rowLockedRGB {
      text-align: center;
    }
  </style>

</head>

<body>

  <div class="container">

    <div class="row mt-3">
      <div class="col">

        <h3 id="chroma-contrast"><a href="https://gka.github.io/chroma.js/#chroma-contrast">chroma.contrast</a>
          <h4 id="-color1-color2-">(color1, color2)</h4>
        </h3>
        <p>Computes the WCAG contrast ratio between two colors. A minimum contrast of 4.5:1 <a
            href="http://www.w3.org/TR/WCAG20-TECHS/G18.html">is recommended</a> to ensure that text is
          still
          readable
          against a background color.</p>

        In order to be Level AA conformant, your page must have all of the
        following:

        <ul>
          <li>A 4.5:1 contrast between the non-link text color and the background.</li>
          <li>A 4.5:1 contrast between the link text color and the background.</li>
          <li>A 3:1 contrast between the link text color and the surrounding non-link text color.</li>
        </ul>

      </div>
    </div>


    <div class="row">
      <div class="col-4">
        <input type="color" id="colorInput1" value="#ffffff">
        <input type="text" id="input1">
      </div>
      <div class="col">
        <input type="color" id="colorInput2" value="#ffffff">
        <input type="text" id="input2">
      </div>
    </div>


    <div class="row my-2" id="rowLockedRGB">
      <div class="col-4">
        <div class="row">

          <div class="col-2">
            <i class="bi-file-lock2" style="font-size: 1.5rem;"></i>
          </div>

          <div class="col">
            <div class="row">
              <div class="col-3"><label for="lockedRGB-R-1">R</label></div>
              <div class="col-3"><label for="lockedRGB-G-1">G</label></div>
              <div class="col-3"><label for="lockedRGB-B-1">B</label></div>
            </div>
            <div class="row">
              <div class="col-3"><input type="checkbox" id="lockedRGB-R-1"></div>
              <div class="col-3"><input type="checkbox" id="lockedRGB-G-1"></div>
              <div class="col-3"><input type="checkbox" id="lockedRGB-B-1"></div>
            </div>
          </div>


        </div>
      </div>

      <div class="col-4">
        <div class="row">

          <div class="col-2">
            <i class="bi-file-lock2" style="font-size: 1.5rem;"></i>
          </div>

          <div class="col">
            <div class="row">
              <div class="col-3"><label for="lockedRGB-R-2">R</label></div>
              <div class="col-3"><label for="lockedRGB-G-2">G</label></div>
              <div class="col-3"><label for="lockedRGB-B-2">B</label></div>
            </div>
            <div class="row">
              <div class="col-3"><input type="checkbox" id="lockedRGB-R-2"></div>
              <div class="col-3"><input type="checkbox" id="lockedRGB-G-2"></div>
              <div class="col-3"><input type="checkbox" id="lockedRGB-B-2"></div>
            </div>
          </div>


        </div>
      </div>


    </div>


    <div class="row">
      <div class="col-4">
        <a tabindex="0" class="btn btn-secondary" id="FixForContrast-1">Fix for contrast</a>
      </div>
      <div class="col">
        <a tabindex="0" class="btn btn-secondary" id="FixForContrast-2">Fix for contrast</a>
      </div>
    </div>


    <div class="row mt-3">
      <div class="col">

        <p>Constrast :</p>
        <div id="resultOutput"></div>

      </div>
    </div>
  </div>



  <script>

    let color1 = chroma('white');
    let color2 = chroma('white');

    let colorInput1 = $('#colorInput1');
    let colorInput2 = $('#colorInput2');
    let input1 = $('#input1');
    let input2 = $('#input2');

    let colors = [null, color1, color2];
    const colorInputs = [null, colorInput1, colorInput2];
    const textInputs = [null, input1, input2];

    function setStyle(inputElement, color) {

      inputElement.css('background-color', color.css());

      if (chroma.contrast(color, 'black') < 4.5 || color.alpha() > 0.5)
        inputElement.css('color', 'white');

      if (chroma.contrast(color, 'white') < 4.5 || color.alpha() < 0.5)
        inputElement.css('color', 'black');
    }

    function controlerViewSetColor(color, colorNum) {

      colorInputs[colorNum].val(color.hex());
      textInputs[colorNum].val(color.hex());

      setStyle(textInputs[colorNum], color);
    }

    function modelStoreColor(color, colorNum) {

      colors[colorNum] = color;
      controlerViewSetColor(color, colorNum);
    }

    function controlerInputReadAndStoreColor(element) {

      const colorNum = element.attr('id').slice(-1);
      const val = element.val();
      if (chroma.valid(val))
        modelStoreColor(chroma(val), colorNum);
    }

    function getColors() {

      const val1 = input1.val().trim();
      const val2 = input2.val().trim();

      input1.val(val1);
      input2.val(val2);

      if (chroma.valid(val1))
        color1 = chroma(val1);

      if (chroma.valid(val2))
        color2 = chroma(val2);
    }

    function setColor(input, color) {
      input.val(color.hex());
      setStyle(input, color);
    }

    function compute() {

      getColors();

      setStyle(input1, color1);
      setStyle(input2, color2);

      $('#resultOutput').text(chroma.contrast(color1, color2));
    }





    function fixForContrast(colorNum, popover) {

      let localInput1, localInput2, localColor1, localColor2;
      if (colorNum == 2) {
        localInput1 = input2;
        localInput2 = input1;

        localColor1 = color2;
        localColor2 = color1;
      } else {
        localInput1 = input1;
        localInput2 = input2;

        localColor1 = color1;
        localColor2 = color2;
      }

      const TARGET_CONTRAST = 4.5;
      if (chroma.contrast(localColor1, localColor2) < TARGET_CONTRAST) {

        const lum1 = localColor1.luminance();
        const lum2 = localColor2.luminance();

        let darkerInput;
        let darkerLum;
        let lighterInput;
        let lighterLum;

        if (lum1 < lum2) {
          darkerInput = localInput1;
          darkerLum = lum1;
          lighterInput = localInput2;
          lighterLum = lum2;
        } else {
          darkerInput = localInput2;
          darkerLum = lum2;
          lighterInput = localInput1;
          lighterLum = lum1;
        }

        const lighterTargetLum = TARGET_CONTRAST * (darkerLum + 0.05) - 0.05;
        const darkerTargetLum = (lighterLum + 0.05) / TARGET_CONTRAST - 0.05;

        let targetLum;

        if (localInput1 == lighterInput)
          targetLum = lighterTargetLum;
        else
          targetLum = darkerTargetLum;

        if (0 > targetLum || targetLum > 1) {

          popover.show();
          setTimeout(() => popover.hide(), 2000);
        }
        else {

          do {
            targetColor1 = localColor1.luminance(targetLum);
            if (localInput1 == lighterInput)
              targetLum += 0.001;
            else
              targetLum -= 0.001;
          }
          while (chroma.contrast(targetColor1, localColor2) < TARGET_CONTRAST)
          // console.log('target : ', targetLum);
          // console.log('color1.luminance() : ', color1.luminance());
          // console.log('diff : ', targetLum - color1.luminance());
          setColor(localInput1, targetColor1);
        }
      }
    }






    for (let i = 1; i < 3; ++i) {

      colorInputs[i].on('input', function () { controlerInputReadAndStoreColor($(this)) });
      textInputs[i].on('input', function () { controlerInputReadAndStoreColor($(this)) });

      for (let colorComp of 'RGB') {
        const id = 'lockedRGB-' + colorComp + '-' + i;
        // console.log(id);
        $('#' + id).change(function () {
          console.log('checked ', $(this));
        });
      }

      fixButton = $('#FixForContrast-' + i);

      const popover = new bootstrap.Popover(fixButton, {
        content: 'Cannot reach 4.5:1 contrast'
        , trigger: 'manual'
      });

      fixButton.click(function () {
        fixForContrast(i, popover);
        compute();
      });

    }

    compute();

  </script>


</body>

</html>