<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>chroma.contrast</title>
  <script src="../extLibs/chroma-2.4.2.min.js"></script>
  <script src="../extLibs/jquery-3.4.1.min.js"></script>
  <script src="../extLibs/popper-2.9.2.min.js"></script>
  <script src="../extLibs/bootstrap-5.0.2-dist/js/bootstrap.min.js"></script>

  <link href="../extLibs/bootstrap-5.0.2-dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../extLibs/bootstrap-icons-1.8.1/bootstrap-icons.css">

  <style>
    input {
      height: 50px;
      font-size: 1em;
    }

    input[type="checkbox"] {
      width: 25px;
      height: 30px;
    }

    #rowLockedRGB label {
      width: 25px;
    }

    #rowLockedRGB {
      text-align: center;
    }
  </style>

</head>

<body>

  <div class="container">

    <div class="row mt-3">
      <div class="col">

        <h3 id="chroma-contrast"><a href="https://gka.github.io/chroma.js/#chroma-contrast">chroma.contrast</a>
          <h4 id="-color1-color2-">(color1, color2)</h4>
        </h3>
        <p>Computes the WCAG contrast ratio between two colors. A minimum contrast of 4.5:1 <a
            href="http://www.w3.org/TR/WCAG20-TECHS/G18.html">is recommended</a> to ensure that text is
          still
          readable
          against a background color.</p>

        In order to be Level AA conformant, your page must have all of the
        following:

        <ul>
          <li>A 4.5:1 contrast between the non-link text color and the background.</li>
          <li>A 4.5:1 contrast between the link text color and the background.</li>
          <li>A 3:1 contrast between the link text color and the surrounding non-link text color.</li>
        </ul>

      </div>
    </div>


    <div class="row">
      <div class="col-4">
        <input type="text" id="input1">
      </div>
      <div class="col">
        <input type="text" id="input2">
      </div>
    </div>


    <div class="row my-2" id="rowLockedRGB">
      <div class="col-4">
        <div class="row">

          <div class="col-2">
            <i class="bi-file-lock2" style="font-size: 1.5rem;"></i>
          </div>

          <div class="col">
            <div class="row">
              <div class="col-3"><label for="lockedRGB-R-1">R</label></div>
              <div class="col-3"><label for="lockedRGB-G-1">G</label></div>
              <div class="col-3"><label for="lockedRGB-B-1">B</label></div>
            </div>
            <div class="row">
              <div class="col-3"><input type="checkbox" id="lockedRGB-R-1"></div>
              <div class="col-3"><input type="checkbox" id="lockedRGB-G-1"></div>
              <div class="col-3"><input type="checkbox" id="lockedRGB-B-1"></div>
            </div>
          </div>


        </div>
      </div>

      <div class="col-4">
        <div class="row">

          <div class="col-2">
            <i class="bi-file-lock2" style="font-size: 1.5rem;"></i>
          </div>

          <div class="col">
            <div class="row">
              <div class="col-3"><label for="lockedRGB-R-2">R</label></div>
              <div class="col-3"><label for="lockedRGB-G-2">G</label></div>
              <div class="col-3"><label for="lockedRGB-B-2">B</label></div>
            </div>
            <div class="row">
              <div class="col-3"><input type="checkbox" id="lockedRGB-R-2"></div>
              <div class="col-3"><input type="checkbox" id="lockedRGB-G-2"></div>
              <div class="col-3"><input type="checkbox" id="lockedRGB-B-2"></div>
            </div>
          </div>


        </div>
      </div>


    </div>


    <div class="row">
      <div class="col-4">
        <a tabindex="0" class="btn btn-secondary" id="FixForContrast-1">Fix for contrast</a>
      </div>
      <div class="col">
        <a tabindex="0" class="btn btn-secondary" id="FixForContrast-2">Fix for contrast</a>
      </div>
    </div>


    <div class="row mt-3">
      <div class="col">

        <p>Constrast :</p>
        <div id="resultOutput"></div>

      </div>
    </div>
  </div>



  <script>

    // var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
    // var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
    //   return new bootstrap.Popover(popoverTriggerEl)
    // })

    function setStyle(inputElement, color) {

      inputElement.css('background-color', color.css());

      if (chroma.contrast(color, 'black') < 4.5)
        inputElement.css('color', 'white');

      if (chroma.contrast(color, 'white') < 4.5)
        inputElement.css('color', 'black');
    }

    function getValAsColor(inputElement) {

      const val = inputElement.val().trim();
      inputElement.val(val);

      return chroma(val);
    }

    function setColor(input, color) {
      input.val(color.hex());
      setStyle(input, color);
    }

    function compute() {

      let input1 = $('#input1');
      let input2 = $('#input2');

      const color1 = getValAsColor(input1);
      const color2 = getValAsColor(input2);

      setStyle(input1, color1);
      setStyle(input2, color2);

      $('#resultOutput').text(chroma.contrast(color1, color2));
    }

    function fixForContrast(colorNum, popover) {

      const input1 = $('#input' + colorNum);
      const input2 = $('#input' + (3 - colorNum));

      let color1 = getValAsColor(input1);
      let color2 = getValAsColor(input2);

      const TARGET_CONTRAST = 4.5;
      if (chroma.contrast(color1, color2) < TARGET_CONTRAST) {

        const lum1 = color1.luminance();
        const lum2 = color2.luminance();

        let darkerInput;
        let darkerLum;
        let lighterInput;
        let lighterLum;

        if (lum1 < lum2) {
          darkerInput = input1;
          darkerLum = lum1;
          lighterInput = input2;
          lighterLum = lum2;
        } else {
          darkerInput = input2;
          darkerLum = lum2;
          lighterInput = input1;
          lighterLum = lum1;
        }

        const lighterTargetLum = TARGET_CONTRAST * (darkerLum + 0.05) - 0.05;
        const darkerTargetLum = (lighterLum + 0.05) / TARGET_CONTRAST - 0.05;

        let targetLum;

        if (input1 == lighterInput)
          targetLum = lighterTargetLum;
        else
          targetLum = darkerTargetLum;

        if (0 > targetLum || targetLum > 1) {

          popover.show();
          setTimeout(() => popover.hide(), 2000);
        }
        else {

          do {
            targetColor1 = color1.luminance(targetLum);
            if (input1 == lighterInput)
              targetLum += 0.001;
            else
              targetLum -= 0.001;
          }
          while (chroma.contrast(targetColor1, color2) < TARGET_CONTRAST)
          // console.log('target : ', targetLum);
          // console.log('color1.luminance() : ', color1.luminance());
          // console.log('diff : ', targetLum - color1.luminance());
          setColor(input1, targetColor1);
        }
      }
    }


    $('#input1').change(compute);
    $('#input2').change(compute);

    for (let i = 1; i < 3; ++i) {

      for (let colorComp of 'RGB') {
        const id = 'lockedRGB-' + colorComp + '-' + i;
        console.log(id);
        $('#' + id).change(function () {
          console.log('checked ', $(this));
        });
      }

      fixButton = $('#FixForContrast-' + i);

      const popover = new bootstrap.Popover(fixButton, {
        content: 'Cannot reach 4.5:1 contrast'
        , trigger: 'manual'
      });

      fixButton.click(function () {
        fixForContrast(i, popover);
        compute();
      });

    }

    compute();

  </script>


</body>

</html>